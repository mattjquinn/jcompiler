sudo: required
dist: xenial
language: rust
cache: cargo
env:
rust:
- stable
- beta
- nightly

install:
- wget http://releases.llvm.org/7.0.1/clang+llvm-7.0.1-x86_64-linux-gnu-ubuntu-16.04.tar.xz
- mkdir $PWD/.clang_llvm7
- tar xf clang+llvm-7.0.1-x86_64-linux-gnu-ubuntu-16.04.tar.xz -C $PWD/.clang_llvm7
- export PATH="$PWD/.clang_llvm7/bin:$PATH"
- cc --version
- which cc
- sudo rm `which cc`
- sudo ln -s $PWD/.clang_llvm7/bin/clang /usr/bin/cc
- cc --version
- llvm-config --version

matrix:
  fast_finish: true
  allow_failures:
  - env: NAME='nightly-publish'
  include:
  - rust: nightly
    sudo: required
    env: NAME='nightly-publish'
    before_script:
    - rustup component add rustfmt
    - rustup component add clippy
    - cargo install cargo-update || echo "cargo-update already installed"
    - cargo install cargo-travis || echo "cargo-travis already installed"
    - cargo install-update -a
    script:
    - cargo fmt -- --check
    - cargo clippy -- -D clippy
    - |
      cargo build    --verbose &&
      cargo coveralls --verbose
    - |
      cargo doc --verbose &&
      cargo doc-upload
    addons:
      apt:
        packages:
        - libcurl4-openssl-dev
        - libelf-dev
        - libdw-dev
        - binutils-dev
        - cmake

script: |
  cargo build --verbose --release &&
  cargo test --verbose -- --test-threads 1 &&
  cargo bench --verbose &&
  cargo doc   --verbose

notifications:
  email: false
